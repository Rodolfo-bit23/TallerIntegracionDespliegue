version: 2.1

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/node:20.9
    working_directory: ~/project/bankchurn-api
    steps:
      - checkout:
          path: ~/project

      - run:
          name: Verificar variables requeridas
          command: |
            for v in RAILWAY_TOKEN RAILWAY_PROJECT_ID RAILWAY_SERVICE_ID; do
              if [ -z "${!v:-}" ]; then
                echo "ERROR: Falta variable $v en CircleCI > Project Settings > Environment Variables"
                exit 1
              fi
            done
            echo "Variables de entorno presentes."

      - run:
          name: Desplegar directamente con Railway (sin login)
          command: |
            npx -y @railway/cli@latest up \
              --project "$RAILWAY_PROJECT_ID" \
              --service "$RAILWAY_SERVICE_ID" \
              --ci \
              --token "$RAILWAY_TOKEN"

workflows:
  version: 2
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway:
          filters:
            branches:
              only:
                - main
