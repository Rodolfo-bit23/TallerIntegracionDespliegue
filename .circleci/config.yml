version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout

      - run:
          name: Verificar variables requeridas
          command: |
            for v in RAILWAY_TOKEN RAILWAY_PROJECT_ID RAILWAY_SERVICE_ID; do
              if [ -z "${!v}" ]; then
                echo "ERROR: Falta variable $v en CircleCI > Project Settings > Environment Variables"
                exit 1
              fi
            done
            echo "Variables de entorno OK"

      # (Opcional) Diagnóstico: lista servicios del proyecto
      - run:
          name: Ver diagnóstico de servicios en el proyecto
          command: |
            npx -y @railway/cli@latest service list --projectId="$RAILWAY_PROJECT_ID"

      - run:
          name: Desplegar a Railway (IDs explícitos)
          command: |
            npx -y @railway/cli@latest up \
              --projectId="$4610234f-bae2-4087-b682-5922e7256947" \
              --serviceId="7d80c812-94f6-48cb-90a1-0645fa77f60d" \
              --ci

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - deploy
