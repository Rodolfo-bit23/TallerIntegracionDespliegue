version: 2.1
orbs:
  node: circleci/node@5.1.0

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/python:3.10
    working_directory: ~/project/bankchurn-api
    steps:
      - checkout:
          path: ~/project
      - node/install:
          node-version: '20.9'
      - run: node --version

      - run:
          name: Verificar variables requeridas
          command: |
            for v in RAILWAY_TOKEN RAILWAY_PROJECT_ID RAILWAY_SERVICE_ID; do
              if [ -z "${!v:-}" ]; then
                echo "ERROR: Falta variable $v"
                exit 1
              fi
            done

      - run:
          name: Link no-interactivo a Railway
          command: |
            npx -y @railway/cli@latest link \
              --project "$RAILWAY_PROJECT_ID" \
              --service "$RAILWAY_SERVICE_ID"

      - run:
          name: Desplegar
          command: |
            npx -y @railway/cli@latest up --ci

workflows:
  version: 2
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway:
          filters:
            branches:
              only: [main]


